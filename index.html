<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Agenda Esportiva</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; margin: 0; padding: 20px; }
    header { background: #343a40; color: white; padding: 20px; text-align: center; font-size: 28px; }
    ul.menu { list-style: none; padding: 0; max-width: 700px; margin: 0 auto; }
    li { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .titulo-evento { font-size: 18px; font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between; }
    .iframe-link { margin-top: 10px; font-size: 14px; word-break: break-all; color: green; }
    li ul { padding-left: 15px; }
    li ul li a { text-decoration: none; color: #007bff; }
  </style>
</head>
<body>
  <header>Agenda Esportiva</header>
  <div id="eventos">Carregando eventos...</div>

  <script>
    const SCRAPER_API_KEY = 'f367a6108ce7e5f1fd57ef78c49bd671';

    function ajustarHorarioBrasil(horaMinuto) {
      if (!horaMinuto) return '';
      const [h, m] = horaMinuto.split(':').map(n => parseInt(n));
      if (isNaN(h) || isNaN(m)) return horaMinuto;

      const dataUTC = new Date(Date.UTC(2020, 0, 1, h, m)); // data fictÃ­cia
      const offset = -3; // GMT-3
      dataUTC.setHours(dataUTC.getHours() + offset);

      return dataUTC.getHours().toString().padStart(2, '0') + ':' +
             dataUTC.getMinutes().toString().padStart(2, '0');
    }

    async function extrairIframe(urlCanal) {
      const url = `https://api.scraperapi.com/?api_key=${SCRAPER_API_KEY}&render=true&wait=4000&url=${encodeURIComponent(urlCanal)}`;
      const resp = await fetch(url);
      const html = await resp.text();
      const match = html.match(/<iframe[^>]+src="([^"]+)"/i);
      return match ? match[1] : 'NÃ£o encontrado';
    }

    async function carregarEventos() {
      const url = 'https://api.allorigins.win/get?url=' + encodeURIComponent('https://todopelotatvhd.com/agenda');
      try {
        const res = await fetch(url);
        const data = await res.json();
        const html = data.contents;

        const temp = document.createElement('div');
        temp.innerHTML = html;

        const listaEventos = temp.querySelector('ul.menu');
        if (!listaEventos) return document.getElementById('eventos').innerHTML = 'Nenhum evento.';

        const eventos = listaEventos.querySelectorAll('li');

        const ul = document.createElement('ul');
        ul.className = 'menu';

        eventos.forEach(evento => {
          const li = document.createElement('li');
          const a = evento.querySelector('a');
          const span = a?.querySelector('span.t');
          const hora = span ? ajustarHorarioBrasil(span.textContent.trim()) : '';
          const titulo = a ? a.childNodes[0].textContent.trim().replace(span?.textContent || '', '').trim() : 'Evento';

          const tituloDiv = document.createElement('div');
          tituloDiv.className = 'titulo-evento';
          tituloDiv.innerHTML = `${titulo} <span>${hora}</span>`;
          li.appendChild(tituloDiv);

          const sublinks = evento.querySelectorAll('li.subitem1 a');
          if (sublinks.length) {
            const ulCanais = document.createElement('ul');
            sublinks.forEach(link => {
              const canalLi = document.createElement('li');
              const aCanal = document.createElement('a');
              aCanal.href = '#';
              aCanal.textContent = link.textContent.trim().replace(/Calidad \d+p/i, '').trim();
              aCanal.onclick = async (e) => {
                e.preventDefault();
                aCanal.textContent = 'ðŸ”Ž Buscando link...';
                const iframeLink = await extrairIframe(link.href);
                const divIframe = document.createElement('div');
                divIframe.className = 'iframe-link';
                divIframe.textContent = iframeLink;
                canalLi.appendChild(divIframe);
                aCanal.textContent = link.textContent.trim();
              };
              canalLi.appendChild(aCanal);
              ulCanais.appendChild(canalLi);
            });
            li.appendChild(ulCanais);
          }

          ul.appendChild(li);
        });

        document.getElementById('eventos').innerHTML = '';
        document.getElementById('eventos').appendChild(ul);
      } catch (e) {
        document.getElementById('eventos').innerText = 'Erro ao carregar eventos.';
      }
    }

    carregarEventos();
  </script>
</body>
</html>